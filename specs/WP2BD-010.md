# WP2BD-010: get_header() Template Loading Function

**Work Package:** WP2BD-010
**Priority:** P0 (HIGHEST - Required for basic page render)
**Complexity:** SIMPLE
**Estimated Time:** 3-4 hours (including tests)
**Dependencies:**
- WP2BD-050 (Hook system - for do_action)
- Backdrop theme system (backdrop_get_path, list_themes)
**Status:** ✅ Implemented
**Implementation Date:** 2025-11-20

---

## OVERVIEW

Implement WordPress's `get_header()` function to load header template files from themes. This is one of the core template loading functions required for any theme to render.

**Function implemented:**
- `get_header($name = null)` - Load header template with optional name specialization

**Related functions (also implemented):**
- `get_footer($name = null)` - Load footer template
- `get_sidebar($name = null)` - Load sidebar template
- `get_template_part($slug, $name = null)` - Load template parts

---

## WORDPRESS BEHAVIOR

### Basic Usage

```php
<?php get_header(); ?>
<!-- Page content -->
<?php get_footer(); ?>
```

### Named Header Usage

```php
<?php get_header('custom'); ?>
<!-- Loads header-custom.php if it exists, otherwise header.php -->
```

### Template Resolution Order

1. **Child theme** (if active): `header-{$name}.php` → `header.php`
2. **Parent theme**: `header-{$name}.php` → `header.php`
3. **Not found**: Returns false, no template loaded

### Action Hook

The function fires the `get_header` action hook BEFORE including the template:

```php
do_action('get_header', $name);
```

This allows plugins/themes to inject code before the header is loaded.

---

## FUNCTION SPECIFICATION

### Signature

```php
function get_header(string|null $name = null) : bool
```

### Parameters

- **$name** (string|null, optional): Name of specialized header template
  - Default: `null` (loads `header.php`)
  - If provided: Looks for `header-{$name}.php` first
  - Examples: `'custom'`, `'home'`, `'single'`

### Return Value

- **true**: Header template found and included successfully
- **false**: No header template found (neither named nor default)

### Global Dependencies

- **$theme** (read): Active theme name from Backdrop
- Uses **do_action()**: Fires 'get_header' hook
- Uses **backdrop_get_path()**: Resolves theme directory path
- Uses **list_themes()**: Gets theme information for child theme support

---

## BACKDROP MAPPING STRATEGY

### Theme Path Resolution

WordPress uses `get_template_directory()` and `get_stylesheet_directory()` to locate themes.

In Backdrop:
```php
$theme_path = backdrop_get_path('theme', $theme_name);
$full_path = BACKDROP_ROOT . '/' . $theme_path . '/header.php';
```

### Child Theme Support

WordPress checks child theme first, then parent theme.

In Backdrop:
```php
$themes = list_themes();
$theme_info = $themes[$theme_name]->info;
$base_theme = $theme_info['base theme'] ?? null;
```

### File Inclusion

WordPress uses `require_once` to prevent multiple inclusions:
```php
require_once $template_file;
```

We maintain this behavior in the WP2BD implementation.

---

## IMPLEMENTATION DETAILS

### File Location

- **Implementation:** `/home/user/wp2bd/implementation/functions/template-loading.php`
- **Tests:** `/home/user/wp2bd/implementation/tests/get_header.test.php`

### Algorithm

```
1. Fire 'get_header' action hook with $name parameter
2. Get active theme from global $theme or config
3. Build list of themes to check (child first, then parent)
4. Build list of templates to check:
   - If $name provided: header-{$name}.php
   - Always: header.php (fallback)
5. For each theme in priority order:
   - For each template filename:
     - Check if file exists
     - If found: require_once and return true
6. If no template found: return false
```

### Edge Cases Handled

1. **No theme set**: Falls back to `config_get('system.core', 'theme_default')`
2. **Theme path not found**: Skips to next theme in list
3. **File doesn't exist**: Continues searching through fallback options
4. **Child theme without base**: Works with single theme only
5. **Multiple calls**: Uses `require_once` to prevent duplicate inclusion

---

## TEST CASES

### Test 1: Basic header.php loading ✅
**Scenario:** Call `get_header()` with no parameters
**Expected:**
- Returns `true`
- Loads `header.php` from active theme
- Outputs header HTML content

### Test 2: Named header template loading ✅
**Scenario:** Call `get_header('custom')`
**Expected:**
- Returns `true`
- Loads `header-custom.php` if it exists
- Does NOT load `header.php`

### Test 3: Fallback behavior ✅
**Scenario:** Call `get_header('nonexistent')`
**Expected:**
- Returns `true`
- Falls back to loading `header.php`
- Outputs default header content

### Test 4: Return false when not found ✅
**Scenario:** Theme has no `header.php` file
**Expected:**
- Returns `false`
- No output generated
- No PHP errors/warnings

### Test 5: Action hook firing ✅
**Scenario:** Add callback to 'get_header' hook
**Expected:**
- Hook callback is executed before template loads
- Hook receives $name parameter
- Works for both default and named headers

### Test 6: Child theme support ✅
**Scenario:** Child theme active with parent theme
**Expected:**
- Checks child theme first
- Falls back to parent theme if not in child
- Correctly uses theme inheritance

### Test 7: Multiple calls (require_once) ✅
**Scenario:** Call `get_header()` twice in same request
**Expected:**
- First call includes template
- Second call returns true but doesn't re-include
- No duplicate output

### Test 8: Theme path resolution ✅
**Scenario:** Verify theme paths are correctly resolved
**Expected:**
- Uses Backdrop's `backdrop_get_path()`
- Constructs correct absolute file paths
- Handles BACKDROP_ROOT correctly

---

## INTEGRATION WITH TWENTY SEVENTEEN THEME

The Twenty Seventeen theme uses `get_header()` in these files:

1. **index.php** - Main template
2. **single.php** - Single post template
3. **page.php** - Page template
4. **archive.php** - Archive template
5. **search.php** - Search results template
6. **404.php** - Error page template

All templates follow this pattern:
```php
<?php get_header(); ?>

<!-- Main content -->

<?php get_footer(); ?>
```

The theme's `header.php` includes:
- DOCTYPE and HTML opening tags
- wp_head() hook
- Site navigation
- Page title
- Featured image (on single posts)

---

## DEPENDENCIES REQUIRED

### Must be implemented first:
1. **Hook system** (WP2BD-050):
   - `do_action()` function
   - Action hook registry

### Backdrop functions used:
1. `backdrop_get_path('theme', $name)` - Get theme directory path
2. `list_themes()` - Get all theme information
3. `config_get('system.core', 'theme_default')` - Get default theme
4. `BACKDROP_ROOT` constant - Root directory path

---

## RELATED FUNCTIONS

All implemented in the same file (`template-loading.php`):

### get_footer($name = null)
Identical behavior to `get_header()` but for footer templates:
- Loads `footer-{$name}.php` or `footer.php`
- Fires `get_footer` action hook
- Same fallback and child theme logic

### get_sidebar($name = null)
Identical behavior for sidebar templates:
- Loads `sidebar-{$name}.php` or `sidebar.php`
- Fires `get_sidebar` action hook
- Same resolution logic

### get_template_part($slug, $name = null)
More flexible template loading:
- Loads `{$slug}-{$name}.php` or `{$slug}.php`
- Used for reusable template parts
- Example: `get_template_part('template-parts/post/content', 'excerpt')`
- Fires `get_template_part_{$slug}` action hook

---

## USAGE EXAMPLES

### Example 1: Basic Header
```php
<!DOCTYPE html>
<html>
<body>
<?php get_header(); ?>

<main>
    <!-- Page content here -->
</main>

<?php get_footer(); ?>
</body>
</html>
```

### Example 2: Custom Header for Home Page
```php
<?php
// In front-page.php or home.php
get_header('home'); // Loads header-home.php

// Custom front page content

get_footer();
?>
```

### Example 3: Hook into Header Loading
```php
// In theme's functions.php or a plugin
add_action('get_header', 'my_custom_header_code');

function my_custom_header_code($name) {
    if ($name === 'home') {
        // Do something special for home header
        echo '<!-- Home page header loading -->';
    }
}
```

### Example 4: Conditional Headers
```php
<?php
if (is_front_page()) {
    get_header('front');
} elseif (is_single()) {
    get_header('single');
} else {
    get_header();
}
?>
```

---

## BACKDROP THEME INTEGRATION

### Where to Place WP Theme Files

WordPress themes converted to Backdrop should be placed in:
```
/themes/twentyseventeen/
    header.php
    header-custom.php
    footer.php
    sidebar.php
    template-parts/
        post/
            content.php
            content-excerpt.php
```

### Module Integration

The WP2BD module should:
1. Load this template-loading.php file during bootstrap
2. Make functions globally available
3. Initialize hook system before any template loading
4. Set up theme globals ($theme, etc.)

---

## TESTING INSTRUCTIONS

### Manual Testing

1. **Set up test theme:**
   ```bash
   mkdir -p themes/test_theme
   echo "name = Test Theme\ntype = theme\nbackdrop = 1.x" > themes/test_theme/test_theme.info
   echo "<?php echo '<h1>Test Header</h1>'; ?>" > themes/test_theme/header.php
   ```

2. **Enable theme:**
   ```php
   theme_enable(array('test_theme'));
   config_set('system.core', 'theme_default', 'test_theme');
   ```

3. **Test function:**
   ```php
   ob_start();
   $result = get_header();
   $output = ob_get_clean();
   echo "Result: " . ($result ? 'true' : 'false') . "\n";
   echo "Output: " . $output;
   ```

### Automated Testing

Run the test suite:
```bash
php core/scripts/run-tests.sh --file implementation/tests/get_header.test.php
```

Expected: All 8 tests pass ✅

---

## PERFORMANCE CONSIDERATIONS

### File System Calls
- Function checks multiple file paths using `file_exists()`
- Consider caching theme paths in production
- Static cache in `_wp2bd_get_theme_info()` reduces `list_themes()` calls

### Optimization Opportunities
1. Cache resolved template paths per theme
2. Store theme inheritance hierarchy
3. Avoid redundant `backdrop_get_path()` calls

### Memory Usage
- `require_once` prevents duplicate inclusions
- Minimal memory overhead (< 1KB per call)

---

## SECURITY CONSIDERATIONS

### Path Traversal Prevention
- Function only checks theme directories
- No user input directly used in paths
- Uses Backdrop's `backdrop_get_path()` for safe path resolution

### File Inclusion Safety
- Only includes files from theme directories
- Uses `file_exists()` before inclusion
- No dynamic file path construction from user input

### XSS Prevention
- Function itself doesn't output data
- Templates are responsible for escaping output
- Recommend using `esc_html()`, `esc_attr()`, etc. in templates

---

## KNOWN LIMITATIONS

1. **No template hierarchy**: Unlike WordPress's full template hierarchy, this implements simple file resolution
2. **No locate_template()**: Doesn't implement WordPress's `locate_template()` helper
3. **No template caching**: Doesn't cache template paths (could be added)
4. **Assumes file system**: Doesn't support alternative template storage

---

## FUTURE ENHANCEMENTS

1. **Template path caching**: Store resolved paths in static array
2. **Template hierarchy**: Implement full WordPress template hierarchy
3. **locate_template() helper**: Add WordPress's template locator function
4. **Template filters**: Add filters for template path modification
5. **Debug mode**: Add logging for template resolution
6. **Performance monitoring**: Track template loading times

---

## REFERENCES

### WordPress Documentation
- [get_header() reference](https://developer.wordpress.org/reference/functions/get_header/)
- [Template Hierarchy](https://developer.wordpress.org/themes/basics/template-hierarchy/)
- [Child Themes](https://developer.wordpress.org/themes/advanced-topics/child-themes/)

### Backdrop Documentation
- [Theme System](https://docs.backdropcms.org/documentation/theme-system)
- [backdrop_get_path()](https://api.backdropcms.org/api/backdrop/core%21includes%21common.inc/function/backdrop_get_path/1)
- [list_themes()](https://api.backdropcms.org/api/backdrop/core%21includes%21theme.inc/function/list_themes/1)

---

## COMPLETION CHECKLIST

- [x] Function implemented
- [x] Helper functions implemented (get_footer, get_sidebar, get_template_part)
- [x] 8 comprehensive test cases written
- [x] Child theme support tested
- [x] Action hooks tested
- [x] Error handling tested
- [x] Documentation completed
- [x] Edge cases handled
- [x] Integration with Backdrop verified
- [x] Code follows WordPress conventions

**Status: COMPLETE ✅**
**Ready for:** Integration with The Loop (WP2BD-LOOP) and content display functions
