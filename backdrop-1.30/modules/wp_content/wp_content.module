<?php
/**
 * @file
 * WordPress Content Block Module
 *
 * Provides a block that renders WordPress theme output for Backdrop nodes.
 */

/**
 * Implements hook_init().
 *
 * Load WordPress compatibility layer on every page load.
 */
function wp_content_init() {
  // Path to the wp theme that contains WordPress compatibility layer
  $wp_theme_path = BACKDROP_ROOT . '/themes/wp';

  // Only proceed if wp theme exists
  if (!file_exists($wp_theme_path . '/template.php')) {
    return;
  }

  // Define the active WordPress theme (hard-coded for now)
  if (!defined('WP2BD_ACTIVE_THEME')) {
    define('WP2BD_ACTIVE_THEME', 'twentyseventeen');
  }

  // Define paths
  if (!defined('WP2BD_THEME_DIR')) {
    define('WP2BD_THEME_DIR', $wp_theme_path);
    define('WP2BD_WP_THEMES_DIR', WP2BD_THEME_DIR . '/wp-content/themes');
    define('WP2BD_ACTIVE_THEME_DIR', WP2BD_WP_THEMES_DIR . '/' . WP2BD_ACTIVE_THEME);
  }

  // Initialize WordPress globals if not already done
  global $wp_query, $wp_filter, $wp_actions, $wp_current_filter, $post, $wp_version;
  if (!isset($wp_filter)) {
    $wp_filter = array();
  }
  if (!isset($wp_actions)) {
    $wp_actions = array();
  }
  if (!isset($wp_current_filter)) {
    $wp_current_filter = array();
  }
  if (!isset($post)) {
    $post = null;
  }
  if (!isset($wp_version)) {
    $wp_version = '4.9';
    $GLOBALS['wp_version'] = '4.9';
  }

  // Load WordPress compatibility classes
  require_once WP2BD_THEME_DIR . '/classes/WP_Post.php';
  require_once WP2BD_THEME_DIR . '/classes/WP_Query.php';

  // Load WordPress compatibility functions
  require_once WP2BD_THEME_DIR . '/functions/hooks.php';
  require_once WP2BD_THEME_DIR . '/functions/escaping.php';
  require_once WP2BD_THEME_DIR . '/functions/loop.php';
  require_once WP2BD_THEME_DIR . '/functions/template-loading.php';
  require_once WP2BD_THEME_DIR . '/functions/content-display.php';
  require_once WP2BD_THEME_DIR . '/functions/conditionals.php';
  require_once WP2BD_THEME_DIR . '/functions/utilities.php';
  require_once WP2BD_THEME_DIR . '/functions/post-metadata.php';
  require_once WP2BD_THEME_DIR . '/functions/stubs.php';

  // Define WordPress helper functions if not already defined
  if (!function_exists('get_template_directory')) {
    function get_template_directory() {
      if (function_exists('dpm')) {
        dpm('get_template_directory() called from wp_content module, returning: ' . WP2BD_ACTIVE_THEME_DIR);
      }
      return WP2BD_ACTIVE_THEME_DIR;
    }
  }

  if (!function_exists('get_template_directory_uri')) {
    function get_template_directory_uri() {
      global $base_url;
      if (!$base_url) {
        $base_url = $GLOBALS['base_url'];
      }
      $theme_path = str_replace($_SERVER['DOCUMENT_ROOT'], '', WP2BD_ACTIVE_THEME_DIR);
      return $base_url . $theme_path;
    }
  }

  if (!function_exists('get_stylesheet_directory')) {
    function get_stylesheet_directory() {
      return get_template_directory();
    }
  }

  if (!function_exists('get_stylesheet_directory_uri')) {
    function get_stylesheet_directory_uri() {
      return get_template_directory_uri();
    }
  }

  if (!function_exists('get_template')) {
    function get_template() {
      return WP2BD_ACTIVE_THEME;
    }
  }

  if (!function_exists('get_stylesheet')) {
    function get_stylesheet() {
      return WP2BD_ACTIVE_THEME;
    }
  }

  if (!function_exists('get_parent_theme_file_path')) {
    function get_parent_theme_file_path($file = '') {
      $path = get_template_directory();
      if (!empty($file)) {
        $path .= '/' . ltrim($file, '/');
      }
      return $path;
    }
  }

  if (!function_exists('get_theme_file_uri')) {
    function get_theme_file_uri($file = '') {
      $uri = get_template_directory_uri();
      if (!empty($file)) {
        $uri .= '/' . ltrim($file, '/');
      }
      return $uri;
    }
  }
}

/**
 * Implements hook_block_info().
 */
function wp_content_block_info() {
  $blocks = array();

  // TEMPORARILY DISABLED - debugging EntityMalformedException
  // Define the WordPress content block
  /*
  $blocks['wordpress_content'] = array(
    'info' => t('WordPress Content'),
    'description' => t('Renders node content using a WordPress theme.'),
    // This block CAN use node context if available, but doesn't require it
    // (making it required causes errors on pages without nodes, like the home page)
    'contexts' => array(
      'node' => 'node',
    ),
  );
  */

  // Also create a block for home/archive pages that doesn't require node context
  $blocks['wordpress_archive'] = array(
    'info' => t('WordPress Archive/Home'),
    'description' => t('Renders multiple nodes using WordPress theme (for home/archive pages).'),
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function wp_content_block_view($delta = '', $settings = array(), $contexts = array()) {
  $block = array();

  // DEBUG: Log that block is being called
  if (function_exists('dpm')) {
    dpm("wp_content_block_view called with delta: $delta");
    dpm($contexts, 'Block contexts');
  }

  switch ($delta) {
    case 'wordpress_content':
      // Single node view - skip if no valid node context
      if (!isset($contexts['node'])) {
        return array(); // No node context, return empty
      }

      // Extract node from context
      $node = NULL;
      if (isset($contexts['node']->data)) {
        $node = $contexts['node']->data;
      } elseif (is_object($contexts['node']) && isset($contexts['node']->nid)) {
        // Sometimes the context IS the node
        $node = $contexts['node'];
      }

      // Validate that we have a proper node
      if (!$node || !isset($node->nid) || !isset($node->type)) {
        if (function_exists('dpm')) {
          dpm('WARNING: node context invalid or missing nid/type');
        }
        return array(); // Return empty block
      }

      if (function_exists('dpm')) {
        dpm($node, 'Node from context');
      }
      $block['subject'] = NULL; // No title (WordPress theme handles it)
      $block['content'] = _wp_content_render_single_node($node);
      break;

    case 'wordpress_archive':
      // Multiple nodes view (home/archive)
      if (function_exists('dpm')) {
        dpm('Rendering wordpress_archive block');
      }
      $block['subject'] = NULL;
      $block['content'] = _wp_content_render_archive();
      break;
  }

  return $block;
}

/**
 * Helper function to render a single node with WordPress theme.
 */
function _wp_content_render_single_node($node) {
  global $wp_query, $post;

  if (function_exists('dpm')) {
    dpm("_wp_content_render_single_node called with nid: " . (isset($node->nid) ? $node->nid : 'NULL'));
  }

  // Always reload the node fully to ensure it has all properties including 'type'
  if (isset($node->nid)) {
    $full_node = node_load($node->nid);
    if ($full_node) {
      $node = $full_node;
      if (function_exists('dpm')) {
        dpm("Node fully loaded: nid={$node->nid}, type={$node->type}, title={$node->title}");
      }
    }
  }

  // Ensure node has type property (bundle) before converting
  if (!isset($node->type)) {
    if (isset($node->nid)) {
      $type_result = db_query('SELECT type FROM {node} WHERE nid = :nid', array(':nid' => $node->nid))->fetchField();
      if ($type_result) {
        $node->type = $type_result;
      } else {
        $node->type = 'page'; // Fallback
      }
    } else {
      $node->type = 'page'; // Fallback
    }
  }

  // Convert Backdrop node to WordPress post
  $post = WP_Post::from_node($node);

  if (function_exists('dpm')) {
    dpm($post, 'WP_Post created from node');
  }

  // Create a WP_Query with this post
  $wp_query = new WP_Query(array(
    'p' => $node->nid,
    'post_type' => 'post',
  ));

  // Manually set up the query state
  $wp_query->posts = array($post);
  $wp_query->post_count = 1;
  $wp_query->current_post = -1; // Start before first post
  $wp_query->is_single = true;
  $wp_query->is_singular = true;
  $wp_query->queried_object = $post;
  $wp_query->queried_object_id = $post->ID;

  if (!isset($wp_query->post)) {
    $wp_query->post = null;
  }

  // Store in GLOBALS
  $GLOBALS['wp_query'] = $wp_query;
  $GLOBALS['post'] = null; // Reset global post until loop starts

  if (function_exists('dpm')) {
    dpm($wp_query, 'WP_Query set up');
    dpm("have_posts() = " . (have_posts() ? 'TRUE' : 'FALSE'));
  }

  // Render using WordPress template
  return _wp_content_delegate_to_template();
}

/**
 * Helper function to render archive/home page with WordPress theme.
 */
function _wp_content_render_archive() {
  global $wp_query, $post;

  // Load published nodes (promoted ones for front page)
  $site_config = config('system.core');
  $select = db_select('node', 'n')
    ->fields('n', array('nid', 'sticky', 'created'))
    ->condition('n.status', 1) // Published only
    ->orderBy('n.sticky', 'DESC')
    ->orderBy('n.created', 'DESC')
    ->addTag('node_access');

  // Check if we're on front page
  $is_front = backdrop_is_front_page();
  if ($is_front) {
    $select->condition('n.promote', 1);
    $limit = $site_config->get('default_nodes_main') ?: 10;
  } else {
    $limit = 20; // Archive page default
  }

  $select->range(0, $limit);
  $nids = $select->execute()->fetchCol();

  $posts = array();
  if (!empty($nids)) {
    try {
      $nodes = node_load_multiple($nids);
      if (function_exists('dpm')) {
        dpm(count($nodes) . ' nodes loaded');
      }
      foreach ($nodes as $node) {
        // Validate node before processing
        if (!isset($node->nid)) {
          if (function_exists('dpm')) {
            dpm('WARNING: Skipping node without nid');
          }
          continue;
        }

        // Ensure each node has type property
        if (!isset($node->type)) {
          if (function_exists('dpm')) {
            dpm("WARNING: Node {$node->nid} missing type, loading from database");
          }
          $type_result = db_query('SELECT type FROM {node} WHERE nid = :nid', array(':nid' => $node->nid))->fetchField();
          if ($type_result) {
            $node->type = $type_result;
          } else {
            if (function_exists('dpm')) {
              dpm("ERROR: Could not load type for node {$node->nid}, skipping");
            }
            continue; // Skip this node
          }
        }

        $posts[] = WP_Post::from_node($node);
      }
    } catch (Exception $e) {
      if (function_exists('dpm')) {
        dpm('Exception loading nodes: ' . $e->getMessage());
      }
      // Return early with error message
      return array(
        '#markup' => '<p>Error loading content: ' . check_plain($e->getMessage()) . '</p>',
      );
    }
  }

  // Create WP_Query with multiple posts
  $wp_query = new WP_Query(array('post_type' => 'post'));
  $wp_query->posts = $posts;
  $wp_query->post_count = count($posts);
  $wp_query->current_post = -1;
  $wp_query->is_home = $is_front;
  $wp_query->is_archive = !$is_front;
  $wp_query->is_front_page = $is_front;

  if (!isset($wp_query->post)) {
    $wp_query->post = null;
  }

  $GLOBALS['wp_query'] = $wp_query;
  $GLOBALS['post'] = null;

  // Render using WordPress template
  return _wp_content_delegate_to_template();
}

/**
 * Helper function to delegate rendering to WordPress template.
 */
function _wp_content_delegate_to_template() {
  global $wp_query;

  // Start output buffering to capture WordPress template output
  ob_start();

  // VERY VISIBLE DEBUG OUTPUT
  echo '<div style="background: red; color: white; padding: 20px; margin: 20px; border: 5px solid yellow; font-size: 24px; font-weight: bold;">';
  echo 'ðŸš¨ HELLO FROM THE WORDPRESS BLOCK! ðŸš¨<br>';
  echo 'This block is definitely rendering!<br>';
  echo 'Current time: ' . date('H:i:s') . '<br>';
  echo '</div>';

  if (function_exists('dpm')) {
    dpm("_wp_content_delegate_to_template called");
    dpm("have_posts() = " . (have_posts() ? 'TRUE' : 'FALSE'));
    if (isset($wp_query)) {
      dpm("wp_query->post_count = " . (isset($wp_query->post_count) ? $wp_query->post_count : 'NULL'));
      dpm("wp_query->posts array size = " . (isset($wp_query->posts) ? count($wp_query->posts) : 'NULL'));
    }
  }

  // Don't manually loop - let the WordPress template do it!
  // The template (single.php, index.php, etc.) will call have_posts() and the_post().

  // Delegate to WordPress template hierarchy
  echo '<div style="background: yellow; padding: 10px; margin: 10px;">';
  echo '<strong>Attempting WordPress template delegation...</strong><br>';

  // Determine which WordPress template to use
  $wp_template = 'index.php';

  if (is_single()) {
    if (file_exists(get_template_directory() . '/single.php')) {
      $wp_template = 'single.php';
    }
  } elseif (is_page()) {
    if (file_exists(get_template_directory() . '/page.php')) {
      $wp_template = 'page.php';
    }
  } elseif (is_home() || is_front_page()) {
    if (file_exists(get_template_directory() . '/home.php')) {
      $wp_template = 'home.php';
    } elseif (file_exists(get_template_directory() . '/front-page.php')) {
      $wp_template = 'front-page.php';
    }
  } elseif (is_archive()) {
    if (file_exists(get_template_directory() . '/archive.php')) {
      $wp_template = 'archive.php';
    }
  }

  echo 'Template file: ' . $wp_template . '<br>';
  echo 'Template directory: ' . get_template_directory() . '<br>';

  // Include the WordPress template
  $template_path = get_template_directory() . '/' . $wp_template;
  if (file_exists($template_path)) {
    echo 'Template found! Including: ' . $template_path . '<br>';
    echo '</div>';
    include $template_path;
  } else {
    echo '<span style="color: red;">ERROR: WordPress template not found: ' . esc_html($wp_template) . '</span><br>';
    echo 'Searched in: ' . esc_html(get_template_directory()) . '<br>';
    echo '</div>';
    // Fallback to simple content
    echo $content;
  }

  // Return the buffered output as block content
  $output = ob_get_clean();

  return array(
    '#markup' => $output,
  );
}
