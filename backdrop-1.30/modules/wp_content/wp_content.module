<?php
/**
 * @file
 * WordPress Content Block Module
 *
 * Provides a block that renders WordPress theme output for Backdrop nodes.
 */

/**
 * Implements hook_init().
 *
 * Load WordPress compatibility layer on every page load.
 */
function wp_content_init() {
  // Don't load WordPress compatibility on admin pages
  if (path_is_admin(current_path())) {
    return;
  }

  // Path to the wp theme that contains WordPress compatibility layer
  $wp_theme_path = BACKDROP_ROOT . '/themes/wp';

  // Only proceed if wp theme exists
  if (!file_exists($wp_theme_path . '/template.php')) {
    return;
  }

  // Define the active WordPress theme from config
  if (!defined('WP2BD_ACTIVE_THEME')) {
    $config = config('wp_content.settings');
    $active_theme = $config->get('active_theme');

    // Fallback to twentysixteen if config not set
    if (empty($active_theme)) {
      $active_theme = 'twentysixteen';
    }

    define('WP2BD_ACTIVE_THEME', $active_theme);
  }

  // Define paths
  if (!defined('WP2BD_THEME_DIR')) {
    define('WP2BD_THEME_DIR', $wp_theme_path);
    define('WP2BD_WP_THEMES_DIR', WP2BD_THEME_DIR . '/wp-content/themes');
    define('WP2BD_ACTIVE_THEME_DIR', WP2BD_WP_THEMES_DIR . '/' . WP2BD_ACTIVE_THEME);
  }

  // Initialize WordPress globals if not already done
  global $wp_query, $wp_filter, $wp_actions, $wp_current_filter, $post, $wp_version, $pagenow;
  if (!isset($wp_filter)) {
    $wp_filter = array();
  }
  if (!isset($wp_actions)) {
    $wp_actions = array();
  }
  if (!isset($wp_current_filter)) {
    $wp_current_filter = array();
  }
  if (!isset($post)) {
    $post = null;
  }
  if (!isset($wp_version)) {
    $wp_version = '4.9';
    $GLOBALS['wp_version'] = '4.9';
  }
  if (!isset($pagenow)) {
    // Set pagenow to 'index.php' for frontend pages (WordPress default)
    $pagenow = 'index.php';
    $GLOBALS['pagenow'] = 'index.php';
  }

  // Load WordPress compatibility classes
  require_once WP2BD_THEME_DIR . '/classes/WP_Post.php';
  require_once WP2BD_THEME_DIR . '/classes/WP_Query.php';

  // Load WordPress compatibility functions
  require_once WP2BD_THEME_DIR . '/functions/hooks.php';
  require_once WP2BD_THEME_DIR . '/functions/escaping.php';
  require_once WP2BD_THEME_DIR . '/functions/i18n.php';
  require_once WP2BD_THEME_DIR . '/functions/loop.php';
  require_once WP2BD_THEME_DIR . '/functions/enqueue.php';
  require_once WP2BD_THEME_DIR . '/functions/template-loading.php';
  require_once WP2BD_THEME_DIR . '/functions/content-display.php';
  require_once WP2BD_THEME_DIR . '/functions/conditionals.php';
  require_once WP2BD_THEME_DIR . '/functions/utilities.php';
  require_once WP2BD_THEME_DIR . '/functions/post-metadata.php';
  require_once WP2BD_THEME_DIR . '/functions/widgets.php';
  // Note: stubs.php and auto-stubs.php archived to _archive/ as of Dec 2024
  // Functions should be properly implemented in the files above

  // Define WordPress helper functions if not already defined
  if (!function_exists('get_template_directory')) {
    function get_template_directory() {
      // if (function_exists('dpm')) {
      //   dpm('get_template_directory() called from wp_content module, returning: ' . WP2BD_ACTIVE_THEME_DIR);
      // }
      return WP2BD_ACTIVE_THEME_DIR;
    }
  }

  if (!function_exists('get_template_directory_uri')) {
    function get_template_directory_uri() {
      global $base_url;
      if (!$base_url) {
        $base_url = $GLOBALS['base_url'];
      }
      $theme_path = str_replace($_SERVER['DOCUMENT_ROOT'], '', WP2BD_ACTIVE_THEME_DIR);
      return $base_url . $theme_path;
    }
  }

  if (!function_exists('get_stylesheet_directory')) {
    function get_stylesheet_directory() {
      return get_template_directory();
    }
  }

  if (!function_exists('get_stylesheet_directory_uri')) {
    function get_stylesheet_directory_uri() {
      return get_template_directory_uri();
    }
  }

  if (!function_exists('get_template')) {
    function get_template() {
      return WP2BD_ACTIVE_THEME;
    }
  }

  if (!function_exists('get_stylesheet')) {
    function get_stylesheet() {
      return WP2BD_ACTIVE_THEME;
    }
  }

  if (!function_exists('get_parent_theme_file_path')) {
    function get_parent_theme_file_path($file = '') {
      $path = get_template_directory();
      if (!empty($file)) {
        $path .= '/' . ltrim($file, '/');
      }
      return $path;
    }
  }

  if (!function_exists('get_theme_file_uri')) {
    function get_theme_file_uri($file = '') {
      $uri = get_template_directory_uri();
      if (!empty($file)) {
        $uri .= '/' . ltrim($file, '/');
      }
      return $uri;
    }
  }

  // Only load WordPress theme functions.php on frontend pages (not admin)
  // Check if we're using the wp theme on the current page
  global $theme_key;
  if ($theme_key === 'wp' && !path_is_admin(current_path())) {
    $theme_functions = WP2BD_ACTIVE_THEME_DIR . '/functions.php';
    if (file_exists($theme_functions)) {
      require_once $theme_functions;
    }
  }

  // Add content filters to convert Backdrop attributes to WordPress classes
  if (function_exists('add_filter')) {
    add_filter('the_content', 'wp_content_convert_backdrop_attributes', 10);
  }
}

/**
 * Implements hook_menu().
 */
function wp_content_menu() {
  $items = array();

  $items['admin/config/content/wp-content'] = array(
    'title' => 'WordPress Content',
    'description' => 'Configure WordPress theme settings',
    'page callback' => 'backdrop_get_form',
    'page arguments' => array('wp_content_settings_form'),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Settings form for WordPress Content module.
 */
function wp_content_settings_form($form, &$form_state) {
  $config = config('wp_content.settings');

  // Get available themes by scanning the directory
  $themes_dir = BACKDROP_ROOT . '/themes/wp/wp-content/themes';
  $available_themes = array();

  if (is_dir($themes_dir)) {
    $theme_dirs = scandir($themes_dir);
    foreach ($theme_dirs as $dir) {
      if ($dir != '.' && $dir != '..' && is_dir($themes_dir . '/' . $dir)) {
        // Check if it has a style.css (basic theme validation)
        if (file_exists($themes_dir . '/' . $dir . '/style.css')) {
          // Try to read theme name from style.css
          $style_css = file_get_contents($themes_dir . '/' . $dir . '/style.css', false, null, 0, 500);
          if (preg_match('/Theme Name:\s*(.+)/i', $style_css, $matches)) {
            $theme_name = trim($matches[1]);
          } else {
            $theme_name = ucwords(str_replace(array('-', '_'), ' ', $dir));
          }
          $available_themes[$dir] = $theme_name;
        }
      }
    }
  }

  // Sort themes alphabetically by name
  asort($available_themes);

  $form['active_theme'] = array(
    '#type' => 'select',
    '#title' => t('Active WordPress Theme'),
    '#description' => t('Select which WordPress theme to use for rendering content.'),
    '#options' => $available_themes,
    '#default_value' => $config->get('active_theme') ?: 'twentysixteen',
    '#required' => TRUE,
  );

  $form['theme_directory'] = array(
    '#type' => 'textfield',
    '#title' => t('Theme Directory'),
    '#description' => t('Path to WordPress themes directory (relative to Backdrop root).'),
    '#default_value' => $config->get('theme_directory') ?: 'themes/wp/wp-content/themes',
    '#required' => TRUE,
  );

  $form['available_themes'] = array(
    '#type' => 'value',
    '#value' => array_keys($available_themes),
  );

  $form['actions']['#type'] = 'actions';
  $form['actions']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save configuration'),
  );

  return $form;
}

/**
 * Submit handler for WordPress Content settings form.
 */
function wp_content_settings_form_submit($form, &$form_state) {
  $config = config('wp_content.settings');

  $config->set('active_theme', $form_state['values']['active_theme']);
  $config->set('theme_directory', $form_state['values']['theme_directory']);
  $config->set('available_themes', $form_state['values']['available_themes']);

  $config->save();

  // Generate active-theme.css file with @import to the selected theme
  $active_theme = $form_state['values']['active_theme'];
  // TODO: Don't hardcode '/themes/wp' - use Backdrop's API to get active theme directory dynamically
  $css_file_path = BACKDROP_ROOT . '/themes/wp/active-theme.css';
  $css_content = "/* Auto-generated by wp_content module - do not edit manually */\n";
  $css_content .= "/* Active WordPress theme: {$active_theme} */\n";
  $css_content .= "@import url(\"wp-content/themes/{$active_theme}/style.css\");\n";

  if (file_put_contents($css_file_path, $css_content) === FALSE) {
    backdrop_set_message(t('Warning: Could not write active-theme.css file.'), 'warning');
  } else {
    backdrop_set_message(t('Active theme CSS file generated for @theme', array('@theme' => $active_theme)));
  }

  backdrop_set_message(t('WordPress theme configuration has been saved.'));
  backdrop_flush_all_caches();
  backdrop_set_message(t('Cache cleared.'));
}

/**
 * Implements hook_css_alter().
 *
 * Dynamically add the active WordPress theme's stylesheet.
 * 
 * @todo This is currently disabled because it causes ksort() errors.
 * For now, stylesheet is hardcoded in themes/wp/wp.info
 */
/*
function wp_content_css_alter(&$css) {
  // Safety check - ensure $css is an array
  if (!is_array($css)) {
    $css = array();
  }

  // Only add CSS on frontend pages
  if (path_is_admin(current_path())) {
    return;
  }

  // Get active theme from config
  $config = config('wp_content.settings');
  $active_theme = $config->get('active_theme');
  
  if (empty($active_theme)) {
    $active_theme = 'twentysixteen'; // Fallback
  }

  // Build path to theme stylesheet
  $theme_css_path = "themes/wp/wp-content/themes/{$active_theme}/style.css";
  
  // Check if file exists
  if (file_exists(BACKDROP_ROOT . '/' . $theme_css_path)) {
    // Add the stylesheet
    $css[$theme_css_path] = array(
      'data' => $theme_css_path,
      'type' => 'file',
      'group' => CSS_DEFAULT,
      'weight' => 100, // Load after other CSS
      'media' => 'all',
      'preprocess' => TRUE,
      'every_page' => FALSE,
    );
  }
}
*/

/**
 * Implements hook_preprocess_html().
 *
 * Add WordPress body classes to Backdrop's <body> tag.
 */
function wp_content_preprocess_html(&$variables) {
  // Only add WordPress classes on frontend pages using wp theme
  global $theme_key;
  if ($theme_key !== 'wp' || path_is_admin(current_path())) {
    return;
  }

  // Initialize WordPress compatibility if not already done
  wp_content_init();

  // Get WordPress body classes
  if (function_exists('get_body_class')) {
    $wp_body_classes = get_body_class();

    // Add WordPress classes to Backdrop's body classes
    if (!empty($wp_body_classes)) {
      foreach ($wp_body_classes as $class) {
        $variables['classes'][] = $class;
      }
    }
  }
}

/**
 * Convert Backdrop data-align attributes to WordPress alignment classes.
 *
 * Backdrop uses data-align="right|left|center" on images, but WordPress themes
 * expect class="alignright|alignleft|aligncenter". This filter converts between them.
 */
function wp_content_convert_backdrop_attributes($content) {
  // Convert data-align="right" to class="alignright"
  $content = preg_replace_callback(
    '/<img([^>]*?)data-align="(right|left|center)"([^>]*?)>/i',
    function($matches) {
      $before = $matches[1];
      $align = $matches[2];
      $after = $matches[3];

      // Check if class attribute already exists
      if (preg_match('/class="([^"]*)"/', $before . $after, $class_match)) {
        // Add alignment class to existing classes
        $existing_classes = $class_match[1];
        $new_classes = trim($existing_classes . ' align' . $align);
        $result = preg_replace('/class="[^"]*"/', 'class="' . $new_classes . '"', $before . $after);
        return '<img' . $result . '>';
      } else {
        // Add new class attribute
        return '<img' . $before . 'class="align' . $align . '"' . $after . '>';
      }
    },
    $content
  );

  return $content;
}

/**
 * Implements hook_block_info().
 */
function wp_content_block_info() {
  $blocks = array();

  // WordPress Page block - runs the entire theme template (RECOMMENDED)
  // This is how WordPress actually works - one template controls everything
  $blocks['wordpress_page'] = array(
    'info' => t('WordPress Page'),
    'description' => t('Runs the theme template file (index.php, single.php, etc.) exactly as WordPress does.'),
  );

  // Legacy individual blocks (kept for backward compatibility)
  $blocks['wordpress_header'] = array(
    'info' => t('WordPress Header (Legacy)'),
    'description' => t('Renders WordPress theme header only. Use WordPress Page block instead.'),
  );

  $blocks['wordpress_content'] = array(
    'info' => t('WordPress Content (Legacy)'),
    'description' => t('Renders main content only. Use WordPress Page block instead.'),
  );

  $blocks['wordpress_sidebar'] = array(
    'info' => t('WordPress Sidebar (Legacy)'),
    'description' => t('Renders sidebar only. Use WordPress Page block instead.'),
  );

  $blocks['wordpress_footer'] = array(
    'info' => t('WordPress Footer (Legacy)'),
    'description' => t('Renders footer only. Use WordPress Page block instead.'),
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function wp_content_block_view($delta = '', $settings = array(), $contexts = array()) {
  $block = array();

  // DEBUG: Log that block is being called
  // if (function_exists('dpm')) {
  //   dpm("wp_content_block_view called with delta: $delta");
  //   dpm($contexts, 'Block contexts');
  // }

  switch ($delta) {
    case 'wordpress_page':
      // Run the entire WordPress template - this is how WordPress actually works!
      $block['subject'] = NULL;
      $block['content'] = _wp_content_render_full_page();
      break;

    case 'wordpress_header':
      // Legacy: Render WordPress header (header.php)
      $block['subject'] = NULL;
      $block['content'] = _wp_content_render_header();
      break;

    case 'wordpress_content':
      // Legacy: Main content area only (no header/footer/sidebar)
      $block['subject'] = NULL;
      $block['content'] = _wp_content_render_main_content();
      break;

    case 'wordpress_sidebar':
      // Legacy: Render WordPress sidebar (sidebar.php)
      $block['subject'] = NULL;
      $block['content'] = _wp_content_render_sidebar();
      break;

    case 'wordpress_footer':
      // Legacy: Render WordPress footer (footer.php)
      $block['subject'] = NULL;
      $block['content'] = _wp_content_render_footer();
      break;
  }

  return $block;
}

/**
 * Implements hook_preprocess_block().
 *
 * Add custom template suggestion for WordPress blocks to bypass HTML validation.
 */
function wp_content_preprocess_block(&$variables) {
  // Check if this is a WordPress block
  if (isset($variables['block']->delta) && strpos($variables['block']->delta, 'wordpress_') === 0) {
    // Add template suggestion for raw output (no wrapper divs)
    // This will use block--wp-content.tpl.php from the wp theme
    $variables['theme_hook_suggestions'][] = 'block__wp_content';
  }
}

/**
 * Render WordPress header (header.php).
 */
function _wp_content_render_header() {
  // Set up WordPress query for header
  _wp_content_setup_query();

  // Fire wp_enqueue_scripts action so theme can enqueue CSS/JS
  // This needs to happen before wp_head() is called
  if (!isset($GLOBALS['wp2bd_scripts_enqueued'])) {
    do_action('wp_enqueue_scripts');
    $GLOBALS['wp2bd_scripts_enqueued'] = TRUE;
  }

  ob_start();

  $header_path = get_template_directory() . '/header.php';
  if (file_exists($header_path)) {
    try {
      include $header_path;
    } catch (Exception $e) {
      echo '<!-- WordPress header.php EXCEPTION: ' . htmlspecialchars($e->getMessage()) . ' -->';
      watchdog('wp_content', 'Header failed: @error', array('@error' => $e->getMessage()), WATCHDOG_ERROR);
    } catch (Error $e) {
      echo '<!-- WordPress header.php FATAL ERROR: ' . htmlspecialchars($e->getMessage()) . ' -->';
      watchdog('wp_content', 'Header FATAL: @error', array('@error' => $e->getMessage()), WATCHDOG_ERROR);
    }
  } else {
    echo '<!-- WordPress header.php not found -->';
  }

  $output = ob_get_clean();

  // SIMPLIFIED: Only strip HTML page structure that Backdrop controls
  // Remove everything from start through opening <body> tag (DOCTYPE, html, head, body)
  $output = preg_replace('/^.*?<body[^>]*>/is', '', $output);

  // Remove closing </body> and </html> tags if present
  $output = preg_replace('/<\/body>\s*<\/html>\s*$/is', '', $output);

  // IMPORTANT: We do NOT strip theme wrapper divs (#page, skip-link, etc.)
  // The theme controls its own structure - we only prevent duplicate html/body tags

  return array(
    '#type' => 'markup',
    '#markup' => $output,
  );
}

/**
 * Render main WordPress content (without header/footer/sidebar).
 */
function _wp_content_render_main_content() {
  // Set up WordPress query
  _wp_content_setup_query();

  ob_start();

  // We need to manually output the content area that normally sits between
  // get_header() and get_footer() in WordPress templates
  // NOTE: The .wrap div is added by the layout template to wrap both content and sidebar

  // For home/archive pages
  if (is_home() || is_front_page() || is_archive()) {
    echo '<div id="primary" class="content-area">';
    echo '<main id="main" class="site-main" role="main">';

    if (have_posts()) {
      while (have_posts()) {
        the_post();
        // Use WordPress template part for content
        // Twenty Seventeen uses template-parts/post/content
        // Twenty Sixteen uses template-parts/content
        if (file_exists(get_template_directory() . '/template-parts/post/content.php')) {
          get_template_part('template-parts/post/content', get_post_format());
        } elseif (file_exists(get_template_directory() . '/template-parts/content.php')) {
          get_template_part('template-parts/content', get_post_format());
        } else {
          // Fallback: render basic article markup for simple themes (like Outlined)
          // that don't use template-parts
          ?>
          <article id="post-<?php the_ID(); ?>" <?php post_class(); ?>>
            <?php if (function_exists('has_post_thumbnail') && has_post_thumbnail()) : ?>
              <div class="post-thumbnail">
                <a href="<?php the_permalink(); ?>">
                  <?php the_post_thumbnail('large'); ?>
                </a>
              </div>
            <?php endif; ?>

            <h2 class="post-title">
              <a href="<?php the_permalink(); ?>"><?php the_title(); ?></a>
            </h2>

            <div class="post-meta">
              Posted on <?php echo get_the_date(); ?> by <?php the_author(); ?>
            </div>

            <div class="post-content">
              <?php the_content(); ?>
            </div>
          </article>
          <?php
        }
      }
    } else {
      if (file_exists(get_template_directory() . '/template-parts/post/content-none.php')) {
        get_template_part('template-parts/post/content', 'none');
      } elseif (file_exists(get_template_directory() . '/template-parts/content-none.php')) {
        get_template_part('template-parts/content', 'none');
      } else {
        // Fallback: simple "no posts" message
        echo '<p>No posts found.</p>';
      }
    }

    echo '</main>';
    echo '</div>';
  }
  // For single posts/pages
  elseif (is_single() || is_page()) {
    echo '<div id="primary" class="content-area">';
    echo '<main id="main" class="site-main" role="main">';

    while (have_posts()) {
      the_post();
      if (file_exists(get_template_directory() . '/template-parts/page/content-page.php')) {
        get_template_part('template-parts/page/content', 'page');
      } elseif (file_exists(get_template_directory() . '/template-parts/content-page.php')) {
        get_template_part('template-parts/content', 'page');
      } else {
        // Fallback: render basic article markup for simple themes
        ?>
        <article id="post-<?php the_ID(); ?>" <?php post_class(); ?>>
          <?php if (function_exists('has_post_thumbnail') && has_post_thumbnail()) : ?>
            <div class="post-thumbnail">
              <?php the_post_thumbnail('large'); ?>
            </div>
          <?php endif; ?>

          <h1 class="post-title"><?php the_title(); ?></h1>

          <div class="post-meta">
            Posted on <?php echo get_the_date(); ?> by <?php the_author(); ?>
          </div>

          <div class="post-content">
            <?php the_content(); ?>
          </div>
        </article>
        <?php
      }
    }

    echo '</main>';
    echo '</div>';
  }

  $output = ob_get_clean();

  return array(
    '#type' => 'markup',
    '#markup' => $output,
  );
}

/**
 * Render WordPress sidebar (sidebar.php).
 */
function _wp_content_render_sidebar() {
  // Check if sidebar was already rendered (e.g., Twenty Fifteen includes sidebar in header.php)
  // This prevents duplicate sidebars.
  if (!empty($GLOBALS['wp2bd_sidebar_rendered'])) {
    return array(
      '#type' => 'markup',
      '#markup' => '<!-- Sidebar already rendered in header -->',
    );
  }

  // Check for themes that include sidebar in their header.php
  // These themes have unique layouts where sidebar is part of the header structure
  $themes_with_sidebar_in_header = array(
    'twentyfifteen', // Twenty Fifteen has sidebar in header.php via get_sidebar()
  );

  // Get current WordPress theme
  $theme_dir = get_template_directory();
  $theme_name = basename($theme_dir);

  if (in_array($theme_name, $themes_with_sidebar_in_header)) {
    // For these themes, sidebar is already in header - don't render again
    return array(
      '#type' => 'markup',
      '#markup' => '<!-- Sidebar is included in header for ' . htmlspecialchars($theme_name) . ' -->',
    );
  }

  // Set up WordPress query for sidebar
  _wp_content_setup_query();

  ob_start();

  $sidebar_path = get_template_directory() . '/sidebar.php';
  if (file_exists($sidebar_path)) {
    try {
      include $sidebar_path;
    } catch (Exception $e) {
      echo '<!-- WordPress sidebar.php EXCEPTION: ' . htmlspecialchars($e->getMessage()) . ' -->';
      watchdog('wp_content', 'Sidebar failed: @error', array('@error' => $e->getMessage()), WATCHDOG_ERROR);
    } catch (Error $e) {
      echo '<!-- WordPress sidebar.php FATAL ERROR: ' . htmlspecialchars($e->getMessage()) . ' -->';
      watchdog('wp_content', 'Sidebar FATAL: @error', array('@error' => $e->getMessage()), WATCHDOG_ERROR);
    }
  } else {
    echo '<!-- WordPress sidebar.php not found -->';
  }

  $output = ob_get_clean();

  return array(
    '#type' => 'markup',
    '#markup' => $output,
  );
}

/**
 * Render WordPress footer (footer.php).
 */
function _wp_content_render_footer() {
  // Set up WordPress query for footer
  _wp_content_setup_query();

  ob_start();

  $footer_path = get_template_directory() . '/footer.php';
  if (file_exists($footer_path)) {
    try {
      include $footer_path;
    } catch (Exception $e) {
      echo '<!-- WordPress footer.php EXCEPTION: ' . htmlspecialchars($e->getMessage()) . ' -->';
      watchdog('wp_content', 'Footer failed: @error', array('@error' => $e->getMessage()), WATCHDOG_ERROR);
    } catch (Error $e) {
      echo '<!-- WordPress footer.php FATAL ERROR: ' . htmlspecialchars($e->getMessage()) . ' -->';
      watchdog('wp_content', 'Footer FATAL: @error', array('@error' => $e->getMessage()), WATCHDOG_ERROR);
    }
  } else {
    echo '<!-- WordPress footer.php not found -->';
  }

  $output = ob_get_clean();

  // SIMPLIFIED: Only strip closing HTML page structure that Backdrop controls
  // Remove closing </body> and </html> tags
  $output = preg_replace('/<\/body>\s*<\/html>\s*$/is', '', $output);

  // IMPORTANT: We do NOT strip theme wrapper closing divs (#page, #content, etc.)
  // The theme opened them in header.php and will close them in footer.php

  return array(
    '#type' => 'markup',
    '#markup' => $output,
  );
}

/**
 * Render complete WordPress page by running the theme's template file.
 * 
 * This is how WordPress actually works:
 * 1. Determine which template to use (index.php, single.php, page.php, etc.)
 * 2. Include that template
 * 3. The template calls get_header(), outputs content, get_sidebar(), get_footer()
 * 
 * This approach ensures themes work exactly as designed.
 */
function _wp_content_render_full_page() {
  // Ensure WordPress compatibility functions are loaded
  // template.php loads all required function files (template-loading.php, etc.)
  $theme_path = BACKDROP_ROOT . '/themes/wp/template.php';
  if (!function_exists('get_sidebar') && file_exists($theme_path)) {
    require_once $theme_path;
  }

  // Set up WordPress query
  _wp_content_setup_query();

  // Fire wp_enqueue_scripts action so theme can enqueue CSS/JS
  if (!isset($GLOBALS['wp2bd_scripts_enqueued'])) {
    do_action('wp_enqueue_scripts');
    $GLOBALS['wp2bd_scripts_enqueued'] = TRUE;
  }

  ob_start();

  // Determine which template to use based on WordPress template hierarchy
  $template = _wp_content_get_template();
  
  if ($template && file_exists($template)) {
    try {
      include $template;
    } catch (Exception $e) {
      echo '<!-- WordPress template EXCEPTION: ' . htmlspecialchars($e->getMessage()) . ' -->';
      watchdog('wp_content', 'Template @template failed: @error', array(
        '@template' => basename($template),
        '@error' => $e->getMessage(),
      ), WATCHDOG_ERROR);
    } catch (Error $e) {
      echo '<!-- WordPress template FATAL ERROR: ' . htmlspecialchars($e->getMessage()) . ' -->';
      watchdog('wp_content', 'Template @template FATAL: @error', array(
        '@template' => basename($template),
        '@error' => $e->getMessage(),
      ), WATCHDOG_ERROR);
    }
  } else {
    echo '<!-- WordPress template not found -->';
    watchdog('wp_content', 'No suitable WordPress template found', array(), WATCHDOG_ERROR);
  }

  $output = ob_get_clean();

  // Instead of stripping WordPress's HTML structure, we INJECT Backdrop's assets
  // into WordPress's output. This lets WordPress themes control their full structure.

  // 1. Inject Backdrop's head content before </head>
  $backdrop_head = backdrop_get_html_head() . "\n" . backdrop_get_css() . "\n" . backdrop_get_js();
  $output = preg_replace('/<\/head>/i', $backdrop_head . "\n</head>", $output, 1);

  // 2. Add Backdrop's body classes to the <body> tag
  // Get body classes that Backdrop wants to add
  $backdrop_body_classes = array('backdrop-wp-theme');
  if (function_exists('path_is_admin') && path_is_admin(current_path())) {
    $backdrop_body_classes[] = 'admin';
  }
  $class_string = implode(' ', $backdrop_body_classes);
  
  // If <body> has existing class attribute, append to it
  if (preg_match('/<body([^>]*)class="([^"]*)"/', $output)) {
    $output = preg_replace('/<body([^>]*)class="([^"]*)"/', '<body$1class="$2 ' . $class_string . '"', $output, 1);
  } else {
    // If no class attribute, add one
    $output = preg_replace('/<body/', '<body class="' . $class_string . '"', $output, 1);
  }

  // 3. Inject footer JS and page_bottom before </body>
  $backdrop_footer = backdrop_get_js('footer');
  $output = preg_replace('/<\/body>/i', $backdrop_footer . "\n</body>", $output, 1);

  return array(
    '#type' => 'markup',
    '#markup' => $output,
  );
}

/**
 * Get the appropriate WordPress template file to use.
 * 
 * Implements a simplified version of WordPress template hierarchy.
 * @see https://developer.wordpress.org/themes/basics/template-hierarchy/
 */
function _wp_content_get_template() {
  $theme_dir = get_template_directory();
  
  // Check current page context
  if (is_single()) {
    // Single post - check single.php, then index.php
    $templates = array('single.php', 'singular.php', 'index.php');
  }
  elseif (is_page()) {
    // Page - check page.php, then singular.php, then index.php
    $templates = array('page.php', 'singular.php', 'index.php');
  }
  elseif (is_home() || is_front_page()) {
    // Home/front page - check home.php, front-page.php, then index.php
    $templates = array('front-page.php', 'home.php', 'index.php');
  }
  elseif (is_archive()) {
    // Archive - check archive.php, then index.php
    $templates = array('archive.php', 'index.php');
  }
  elseif (is_search()) {
    // Search - check search.php, then index.php
    $templates = array('search.php', 'index.php');
  }
  elseif (is_404()) {
    // 404 - check 404.php, then index.php
    $templates = array('404.php', 'index.php');
  }
  else {
    // Fallback to index.php
    $templates = array('index.php');
  }
  
  // Find the first template that exists
  foreach ($templates as $template) {
    $path = $theme_dir . '/' . $template;
    if (file_exists($path)) {
      return $path;
    }
  }
  
  return NULL;
}

/**
 * Helper: Set up WordPress query globals from Backdrop data.
 */
function _wp_content_setup_query() {
  global $wp_query, $post;

  // If query already set up, don't redo it
  if (isset($GLOBALS['wp2bd_query_setup'])) {
    return;
  }

  // Load published nodes (promoted ones for front page)
  $site_config = config('system.core');
  $select = db_select('node', 'n')
    ->fields('n', array('nid', 'type', 'sticky', 'created'))
    ->condition('n.status', 1)
    ->orderBy('n.sticky', 'DESC')
    ->orderBy('n.created', 'DESC')
    ->addTag('node_access');

  $is_front = backdrop_is_front_page();
  if ($is_front) {
    $select->condition('n.promote', 1);
    $limit = $site_config->get('default_nodes_main') ?: 10;
  } else {
    $limit = 20;
  }

  $select->range(0, $limit);
  $nids = $select->execute()->fetchCol();

  $posts = array();
  if (!empty($nids)) {
    $nodes = node_load_multiple($nids);
    foreach ($nodes as $node) {
      // Skip if not a valid node object
      if (!is_object($node) || !isset($node->nid)) {
        continue;
      }

      // Ensure node has all required properties
      if (!isset($node->type)) {
        // Try to reload the node fully
        $full_node = node_load($node->nid);
        if ($full_node && isset($full_node->type)) {
          $node = $full_node;
        } else {
          // Last resort: query database directly
          $type_result = db_query('SELECT type FROM {node} WHERE nid = :nid', array(':nid' => $node->nid))->fetchField();
          if ($type_result) {
            $node->type = $type_result;
          } else {
            continue;
          }
        }
      }

      // Double-check we have type before creating WP_Post
      if (!isset($node->type)) {
        continue;
      }

      $posts[] = WP_Post::from_node($node);
    }
  }

  // Set up WP_Query
  $wp_query = new WP_Query(array('post_type' => 'post'));
  $wp_query->posts = $posts;
  $wp_query->post_count = count($posts);
  $wp_query->current_post = -1;
  $wp_query->is_home = $is_front;
  $wp_query->is_archive = !$is_front;
  $wp_query->is_front_page = $is_front;
  $wp_query->post = null;

  $GLOBALS['wp_query'] = $wp_query;
  $GLOBALS['post'] = null;
  $GLOBALS['wp2bd_query_setup'] = TRUE;
}
